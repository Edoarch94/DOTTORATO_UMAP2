<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Epigrafe Claudia Nova â€” Three.js</title>
<style>
  :root{--bg:#111;--card:#1b1b1b}
  html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;flex-direction:column;gap:12px;padding:12px}
  h1{margin:0 auto;font:700 20px/1.2 system-ui;width:min(96vw,1200px)}
  #stage{position:relative;width:min(96vw,1200px);height:min(80vh,760px);margin:0 auto;border-radius:14px;overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,.45);background:#0e0e0e}
  canvas{display:block;width:100%;height:100%}

  .panel{width:min(96vw,1200px);margin:0 auto;background:var(--card);border-radius:12px;padding:10px;display:grid;gap:8px;grid-template-columns:repeat(6,1fr)}
  .group{background:rgba(255,255,255,.05);border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  label{font-size:12px;opacity:.8}
  input[type=range]{width:100%}
  button{border:0;border-radius:10px;padding:9px 12px;background:#2a2a2a;color:#fff;font-weight:600;cursor:pointer}
  .btn-ghost{background:transparent;outline:1px solid rgba(255,255,255,.25)}
  .btn-ghost.on{box-shadow:0 0 0 2px rgba(74,222,128,.55) inset; background:#233a2d}

  .hotspot{position:absolute;width:24px;height:24px;border-radius:50%;background:#2b74ff;border:1px solid #fff;color:#fff;display:flex;align-items:center;justify-content:center;font:800 12px/1 system-ui;box-shadow:0 2px 6px rgba(0,0,0,.45);transform:translate(-50%,-50%);cursor:pointer;z-index:10}
  .popup{position:absolute;width: clamp(220px, 26vw, 320px);max-height:60vh;background:rgba(18,18,18,.96);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:14px;display:none;overflow:auto;z-index:9}
  .popup.show{display:block}
  .popup.right{transform:translate(80px,-50%)} .popup.left{transform:translate(-100%,-50%)}
  .label{padding:6px 8px;border-radius:8px;background:#111;color:#fff;border:1px solid rgba(255,255,255,.25);font:600 12px/1.2 system-ui;pointer-events:none}
  .badge{position:absolute;top:8px;left:8px;z-index:20;padding:6px 8px;border-radius:8px;background:rgba(14,165,233,.12);color:#93c5fd;border:1px solid rgba(147,197,253,.35);font:600 12px/1.2 system-ui;display:none}
  @media (max-width:900px){.panel{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:560px){.panel{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Epigrafe Claudia Nova</h1>
  <div id="stage"><div id="badge" class="badge">HOTSPOT MODE</div></div>

  <div class="panel">
    <div class="group"><label>Misurazione</label>
      <div class="row"><button id="measure" class="btn-ghost">Misura Aâ€“B</button><button id="measureReset" class="btn-ghost">Reset</button></div>
      <small id="mhelp" style="opacity:.75">Clicca A poi B sulla mesh.</small>
    </div>

    <div class="group"><label>Zoom (FOV)</label><input id="fov" type="range" min="25" max="75" step="1" value="45"></div>

    <div class="group"><label>LuminositÃ </label><input id="exposure" type="range" min="1.0" max="3.0" step="0.05" value="2.6"></div>

    <div class="group"><label>Camera</label>
      <div class="row"><button id="fit" class="btn-ghost">Inquadra</button><button id="reset" class="btn-ghost">Reset</button></div>
    </div>

    <div class="group"><label>Ambiente</label>
      <div class="row"><button class="btn-ghost env on" data-hdr="on">HDR</button><button class="btn-ghost env" data-hdr="off">None</button></div>
    </div>

    <div class="group"><label>Sfondo</label>
      <div class="row">
        <button class="btn-ghost bg on" data-bg="dark">Nero</button>
        <button class="btn-ghost bg" data-bg="light">Bianco</button>
        <button class="btn-ghost bg" data-bg="transparent">Trasparente</button>
        <button class="btn-ghost bg" data-bg="gradient">Gradiente</button>
      </div>
    </div>

    <div class="group"><label>Orientamento</label>
      <div class="row">
        <button id="rzp" class="btn-ghost">Z +90Â°</button>
        <button id="ryp" class="btn-ghost">Y +180Â°</button>
        <button id="rotReset" class="btn-ghost">Reset rot.</button>
        <button id="rotDump" class="btn-ghost">Salva rot.</button>
      </div>
    </div>

    <div class="group"><label>Hotspot</label>
      <div class="row"><button id="toggleH" class="btn-ghost">ModalitÃ  H</button></div>
      <small>Premi anche la <b>H</b> da tastiera</small>
    </div>

    <!-- PANNELLO LUCI -->
    <div class="group" style="grid-column:1/-1">
      <label>ðŸ’¡ Luci</label>
      <div class="row" style="gap:18px;flex-wrap:wrap">
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Key (destra)</span><span id="valKey">2.2</span></div>
          <input id="keyIntensity" type="range" min="0" max="4" step="0.05" value="2.2">
        </div>
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Direzionale</span><span id="valDir">3.0</span></div>
          <input id="dirIntensity" type="range" min="0" max="4" step="0.05" value="3.0">
        </div>
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Fill</span><span id="valFill">1.8</span></div>
          <input id="fillIntensity" type="range" min="0" max="3" step="0.05" value="1.8">
        </div>
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Hemi</span><span id="valHemi">1.6</span></div>
          <input id="hemiIntensity" type="range" min="0" max="3" step="0.05" value="1.6">
        </div>
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Ambiente</span><span id="valAmb">0.25</span></div>
          <input id="ambIntensity" type="range" min="0" max="1" step="0.01" value="0.25">
        </div>
        <div style="min-width:180px;flex:1">
          <div style="display:flex;justify-content:space-between"><span>Riflessi (envMap)</span><span id="valEnvI">2.6</span></div>
          <input id="envIntensity" type="range" min="0" max="5" step="0.1" value="2.6">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Three UMD r146 + tween + helpers -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/RGBELoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/renderers/CSS2DRenderer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

<script>
function setActive(btn,on){ btn.classList.toggle('on', !!on); }
function setExclusiveActive(list,activeBtn){ list.forEach(b=>b.classList.toggle('on', b===activeBtn)); }

const stage = document.getElementById('stage');
const badge = document.getElementById('badge');

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e0e0e);

const camera = new THREE.PerspectiveCamera(45, stage.clientWidth/stage.clientHeight, 0.01, 100);
camera.position.set(0.9, 0.9, 1.8);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(stage.clientWidth, stage.clientHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 2.6;  // luminositÃ  di base
renderer.physicallyCorrectLights = true;
stage.appendChild(renderer.domElement);

const labelRenderer = new THREE.CSS2DRenderer();
labelRenderer.setSize(stage.clientWidth, stage.clientHeight);
labelRenderer.domElement.style.position = 'absolute';
labelRenderer.domElement.style.left = '0';
labelRenderer.domElement.style.top = '0';
labelRenderer.domElement.style.pointerEvents = 'none';
stage.appendChild(labelRenderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* Luci */
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.6);
const dir  = new THREE.DirectionalLight(0xffffff, 3.0); dir.position.set(2,2,2);
const fill = new THREE.DirectionalLight(0xffffff, 1.8); fill.position.set(-2,1.2,-1.5);
const amb  = new THREE.AmbientLight(0xffffff, 0.25);

// key-light destra mirata alla faccia destra
const rightKey = new THREE.SpotLight(0xffffff, 2.2, 5, Math.PI/8, 0.2, 1.0);
rightKey.position.set(1.2, 0.6, 0.6);
rightKey.target.position.set(0.0, 0.3, -0.1);

scene.add(hemi, dir, fill, amb, rightKey, rightKey.target);

/* HDR */
let envTexture = null;
new THREE.RGBELoader()
  .setPath('https://cdn.jsdelivr.net/npm/three@0.146.0/examples/textures/equirectangular/')
  .load('venice_sunset_1k.hdr', (tex)=>{
    tex.mapping = THREE.EquirectangularReflectionMapping;
    envTexture = tex;
    scene.environment = envTexture;   // ON di default
  });

/* Orientamento corretto (y â‰ˆ 0) */
const ORIENT = { x: 1.57080, y: 0.0, z: 4.71239 };
let model = null;
const defaultRotation = new THREE.Euler(ORIENT.x, ORIENT.y, ORIENT.z, 'XYZ');

new THREE.GLTFLoader().load(
  'https://edoarch94.github.io/DOTTORATO_UMAP2/modelli/Epigrafe.glb?v=9',
  (g)=>{
    model = g.scene;
    model.rotation.copy(defaultRotation);

    // set envMapIntensity e un minimo tuning
    model.traverse(o=>{
      if(o.isMesh){
        o.castShadow = o.receiveShadow = true;
        const m = o.material;
        if(m){
          if('envMapIntensity' in m) m.envMapIntensity = 2.6;
          if('roughness' in m) m.roughness = Math.min(0.85, m.roughness ?? 0.85);
          if('metalness' in m) m.metalness = Math.min(0.1, m.metalness ?? 0.0);
          m.needsUpdate = true;
        }
      }
    });

    // centra
    const box  = new THREE.Box3().setFromObject(model);
    const ctr  = box.getCenter(new THREE.Vector3());
    model.position.sub(ctr);
    scene.add(model);

    fitToObject(model, 1.25);
  },
  undefined,
  (e)=>console.error('Errore GLB', e)
);

function fitToObject(object, margin = 1.25){
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const radius = size.length() * 0.5;
  const fov = camera.fov * (Math.PI/180);
  const dist = (radius / Math.sin(fov/2)) * margin;
  const dirv = new THREE.Vector3(0, 0.35, 1).normalize();
  const newPos = dirv.multiplyScalar(dist);
  controls.target.set(0,0,0);
  camera.position.copy(newPos);
  camera.lookAt(controls.target);
  camera.updateProjectionMatrix();
}

/* Raycast */
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
function raycast(e){
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = model ? raycaster.intersectObject(model, true) : [];
  return hits[0] || null;
}

/* Misurazione */
const measureBtn   = document.getElementById('measure');
const measureReset = document.getElementById('measureReset');
const mhelp        = document.getElementById('mhelp');

const A = new THREE.Mesh(new THREE.SphereGeometry(0.01,16,16), new THREE.MeshBasicMaterial({color:0x22c55e}));
const B = A.clone(); A.visible=B.visible=false; scene.add(A,B);
const lineAB = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(),new THREE.Vector3()]), new THREE.LineBasicMaterial({color:0x22c55e}));
lineAB.visible=false; scene.add(lineAB);
const distLabelEl = document.createElement('div'); distLabelEl.className='label'; distLabelEl.textContent='0.000 m';
const distLabel = new THREE.CSS2DObject(distLabelEl); distLabel.visible=false; scene.add(distLabel);

const measuring = {active:false, step:0, a:new THREE.Vector3(), b:new THREE.Vector3()};
function setMeasureActive(on){
  measuring.active = on; measuring.step = 0;
  A.visible = B.visible = lineAB.visible = distLabel.visible = false;
  mhelp.textContent = on ? 'Clicca A poi B sulla mesh.' : 'Clicca Aâ€“B per misurare.';
}
measureBtn.onclick = ()=>{ setMeasureActive(!measuring.active); setActive(measureBtn, measuring.active); };
measureReset.onclick = ()=>{ setMeasureActive(false); setActive(measureBtn, false); };

renderer.domElement.addEventListener('click', (e)=>{
  if(!measuring.active) return;
  const hit = raycast(e); if(!hit) return;
  if(measuring.step===0){
    measuring.a.copy(hit.point); A.position.copy(hit.point); A.visible=true; measuring.step=1;
  } else {
    measuring.b.copy(hit.point); B.position.copy(hit.point); B.visible=true;
    lineAB.geometry.setFromPoints([measuring.a, measuring.b]); lineAB.visible=true;
    const mid = measuring.a.clone().add(measuring.b).multiplyScalar(0.5);
    distLabel.position.copy(mid); distLabel.visible=true;
    distLabelEl.textContent = measuring.a.distanceTo(measuring.b).toFixed(3)+' m';
    measuring.step=0;
  }
});

/* Hotspot dati (aggiornati) */
const HOTSPOTS = [
  { id:1, pos:[ 0.020, 0.627, -0.192], nor:[0.959, 0.117, 0.257], title:'Lettera S', text:'Errato calcolo dello spazio â†’ lettera S incisa sopra la cornice.' },
  { id:2, pos:[ 0.023, 0.331, -0.194], nor:[0.555,-0.060, 0.829], title:'Lettera M', text:'Ravvicinamento delle lettere e sbordatura della M sulla cornice.' },
  { id:3, pos:[ 0.069, 0.186,  0.249], nor:[0.978, 0.177,-0.114], title:'ATTERNUM', text:'Variante locale (rif. CIL IX 5979), possibile influsso osco-umbro.' },
  { id:4, pos:[ 0.010, 0.742, -0.247], nor:[0.811,-0.025,-0.584], title:'Supporto lapideo', text:'Pietra calcarea con tonalitÃ  rossastra nello specchio epigrafico.' }
];

const hUI = [];
function stageRect(){ return renderer.domElement.getBoundingClientRect(); }
function screenXY(v){
  const s = v.clone().project(camera), r = stageRect();
  return { x:(s.x*0.5+0.5)*r.width, y:(-s.y*0.5+0.5)*r.height };
}
function buildHotspots(){
  HOTSPOTS.forEach(h=>{
    const pos = new THREE.Vector3(...h.pos);
    const nor = new THREE.Vector3(...h.nor).normalize();
    const btn = document.createElement('div'); btn.className='hotspot'; btn.textContent=h.id; stage.appendChild(btn);
    const pop = document.createElement('div'); pop.className='popup'; pop.innerHTML = `<strong>${h.title}</strong><br>${h.text}`; stage.appendChild(pop);
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); focusOn(pos, nor); placePopup(pop, pos); togglePopup(pop); });
    hUI.push({pos,nor,btn,pop});
  });
}
function placePopup(pop, worldPos){
  const r = stageRect();
  const s = screenXY(worldPos);
  pop.style.top = `${s.y}px`; pop.style.left = `${s.x}px`;
  pop.classList.remove('left','right');
  pop.classList.add( s.x < r.width/2 ? 'right' : 'left' );
  requestAnimationFrame(()=>{
    const pr = pop.getBoundingClientRect();
    let top = s.y - pr.height/2, pad = 8;
    top = Math.max(pad, Math.min(innerHeight - pr.height - pad, top));
    pop.style.top = `${top}px`;
  });
}
function togglePopup(pop){
  document.querySelectorAll('.popup.show').forEach(p=>{ if(p!==pop) p.classList.remove('show'); });
  pop.classList.toggle('show');
}
function updateHotspotButtons(){
  hUI.forEach(({pos,btn,pop})=>{
    const s = screenXY(pos);
    btn.style.left = `${s.x}px`; btn.style.top  = `${s.y}px`;
    if(pop.classList.contains('show')) placePopup(pop, pos);
  });
}

/* Zoom dolce */
function focusOn(point, normal){
  const targetFrom = controls.target.clone();
  const camFrom = camera.position.clone();
  const currentDist = camera.position.distanceTo(controls.target);
  const dist = THREE.MathUtils.clamp(currentDist*0.4, 0.22, 0.7);
  const camTo = point.clone().add(normal.clone().normalize().multiplyScalar(dist));
  const t = {a:0};
  new TWEEN.Tween(t).to({a:1},650).easing(TWEEN.Easing.Cubic.Out)
    .onUpdate(()=>{
      controls.target.lerpVectors(targetFrom, point, t.a);
      camera.position.lerpVectors(camFrom, camTo, t.a);
      camera.lookAt(controls.target);
    }).start();
}

/* UI base */
document.getElementById('fov').oninput      = e => { camera.fov = +e.target.value; camera.updateProjectionMatrix(); };
document.getElementById('exposure').oninput = e => { renderer.rayTone ?? 0; renderer.toneMappingExposure = +e.target.value; };
document.getElementById('fit').onclick = ()=>{ fitToObject(model ?? scene, 1.25); };
document.getElementById('reset').onclick = ()=>{
  controls.reset(); controls.target.set(0,0,0);
  new TWEEN.Tween(camera).to({fov:45},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(()=> camera.updateProjectionMatrix()).start();
};

const envBtns = document.querySelectorAll('.env');
envBtns.forEach(btn=>{
  btn.onclick = ()=>{
    if(btn.dataset.hdr === 'on' && envTexture){
      scene.environment = envTexture;
      if(model){ model.traverse(o=>{ if(o.isMesh && o.material && 'envMapIntensity' in o.material){ o.material.envMapIntensity = +document.getElementById('envIntensity').value; o.material.needsUpdate = true; } }); }
    } else {
      scene.environment = null;
    }
    setExclusiveActive(envBtns, btn);
  };
});

const bgBtns = document.querySelectorAll('.bg');
bgBtns.forEach(btn=>{
  btn.onclick = ()=>{
    const m=btn.dataset.bg;
    if(m==='dark'){ scene.background=new THREE.Color(0x0e0e0e); stage.style.background='#0e0e0e'; }
    if(m==='light'){ scene.background=new THREE.Color(0xf7f7f7); stage.style.background='#f7f7f7'; }
    if(m==='transparent'){ scene.background=null; stage.style.background='transparent'; }
    if(m==='gradient'){ scene.background=null; stage.style.background='linear-gradient(180deg,#0e0e0e,#1a1a1a)'; }
    setExclusiveActive(bgBtns, btn);
  };
});

/* Rotazione debug */
document.getElementById('rzp').onclick = ()=>{ if(!model) return; model.rotation.z += Math.PI/2; };
document.getElementById('ryp').onclick = ()=>{ if(!model) return; model.rotation.y += Math.PI;   };
document.getElementById('rotReset').onclick = ()=>{ if(!model) return; model.rotation.copy(defaultRotation); };
document.getElementById('rotDump').onclick  = ()=>{ if(!model) return; const r = model.rotation; console.log(`ORIENT: { x:${r.x.toFixed(5)}, y:${r.y.toFixed(5)}, z:${r.z.toFixed(5)} }`); };

/* Hotspot mode (H) */
let hotspotMode=false;
function toggleH(){ hotspotMode=!hotspotMode; badge.style.display=hotspotMode?'block':'none'; setActive(document.getElementById('toggleH'), hotspotMode); console.log(hotspotMode?'ðŸŸ¦ Hotspot mode ON â€” clicca la pietra.':'â¬› Hotspot mode OFF'); }
document.getElementById('toggleH').onclick=toggleH;
addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='h') toggleH(); });
renderer.domElement.addEventListener('click', (e)=>{
  if(!hotspotMode) return;
  const hit = raycast(e); if(!hit) return;
  const p = hit.point; const n = hit.face?.normal?.clone().transformDirection(hit.object.matrixWorld) || new THREE.Vector3(0,0,1);
  console.clear();
  console.log(`data-position="${p.x.toFixed(3)}m ${p.y.toFixed(3)}m ${p.z.toFixed(3)}m"\ndata-normal="${n.x.toFixed(3)}m ${n.y.toFixed(3)}m ${n.z.toFixed(3)}m"`);
});

buildHotspots();

/* Slider luci */
const keyS = document.getElementById('keyIntensity');
const dirS = document.getElementById('dirIntensity');
const fillS= document.getElementById('fillIntensity');
const hemiS= document.getElementById('hemiIntensity');
const ambS = document.getElementById('ambIntensity');
const envS = document.getElementById('envIntensity');

function updLbl(el, v){ el.textContent = (+v).toFixed(2).replace(/\.00$/,''); }
keyS.oninput = e=>{ rightKey.intensity = +e.target.value; updLbl(document.getElementById('valKey'), e.target.value); };
dirS.oninput = e=>{ dir.intensity      = +e.target.value; updLbl(document.getElementById('valDir'), e.target.value); };
fillS.oninput= e=>{ fill.intensity     = +e.target.value; updLbl(document.getElementById('valFill'), e.target.value); };
hemiS.oninput= e=>{ hemi.intensity     = +e.target.value; updLbl(document.getElementById('valHemi'), e.target.value); };
ambS.oninput = e=>{ amb.intensity      = +e.target.value; updLbl(document.getElementById('valAmb'), e.target.value); };
envS.oninput = e=>{
  updLbl(document.getElementById('valEnvI'), e.target.value);
  if(model){
    model.traverse(o=>{ if(o.isMesh && o.material && 'envMapIntensity' in o.material){ o.material.envMapIntensity = +e.target.value; o.material.needsUpdate = true; } });
  }
};

/* Comandi console per orbita */
function orbitTo(thetaDeg, phiDeg, distance){
  const t = THREE.MathUtils.degToRad(thetaDeg);
  const p = THREE.MathUtils.degToRad(phiDeg);
  const x = distance * Math.sin(p) * Math.sin(t);
  const y = distance * Math.cos(p);
  const z = distance * Math.sin(p) * Math.cos(t);
  const fromPos = camera.position.clone();
  const toPos   = new THREE.Vector3(x,y,z).add(controls.target);
  const tween = {a:0};
  new TWEEN.Tween(tween).to({a:1},700).easing(TWEEN.Easing.Cubic.Out)
    .onUpdate(()=>{
      camera.position.lerpVectors(fromPos, toPos, tween.a);
      camera.lookAt(controls.target);
    }).start();
}
window.orbitTo = orbitTo;
window.dumpOrbit = () => {
  const v = camera.position.clone().sub(controls.target);
  const r = v.length();
  const phi   = Math.acos(v.y / r);
  const theta = Math.atan2(v.x, v.z);
  console.log(`theta=${THREE.MathUtils.radToDeg(theta).toFixed(1)}Â°, phi=${THREE.MathUtils.radToDeg(phi).toFixed(1)}Â°, dist=${r.toFixed(3)}m`);
};

/* Resize & loop */
function onResize(){
  const w = stage.clientWidth, h = stage.clientHeight;
  camera.aspect = w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h); labelRenderer.setSize(w,h);
  updateHotspotButtons();
}
addEventListener('resize', onResize);

(function animate(){
  requestAnimationFrame(animate);
  controls.update();
  TWEEN.update();
  renderer.render(scene, camera);
  labelRenderer.render(scene, camera);
  updateHotspotButtons();
})();
</script>
</body>
</html>
