<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monumento funerario Peltuinum — Three.js (Dock laterali)</title>
<style>
  :root{--bg:#111;--card:#1b1b1b}
  html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;flex-direction:column;gap:12px;padding:12px}
  h1{margin:0 auto;font:700 20px/1.2 system-ui;width:min(96vw,1200px)}

  /* STAGE + DOCKS */
  #stage{
    position:relative;
    width:min(96vw,1200px);
    height:min(80vh,760px);
    margin:0 auto;
    border-radius:14px;
    overflow:hidden;
    box-shadow:0 8px 28px rgba(0,0,0,.45);
    background:#0e0e0e
  }
  canvas{display:block;width:100%;height:100%}
  #badge{
    position:absolute;top:8px;left:8px;z-index:20;
    padding:6px 8px;border-radius:8px;
    background:rgba(14,165,233,.12);color:#93c5fd;
    border:1px solid rgba(147,197,253,.35);
    font:600 12px/1.2 system-ui;
    display:none
  }

  .dock{
    position:absolute;
    top:0; bottom:0;
    width:28%;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:12px;
    pointer-events:none;
  }
  .dock.left  { left:0;  background:linear-gradient(90deg,rgba(0,0,0,.25),rgba(0,0,0,0)); }
  .dock.right { right:0; background:linear-gradient(-90deg,rgba(0,0,0,.25),rgba(0,0,0,0)); }

  .dock-card{
    pointer-events:auto;
    background:rgba(18,18,18,.96);
    border:1px solid rgba(255,255,255,.22);
    border-radius:12px;
    padding:14px 16px;
    max-height:46vh;
    overflow:auto;
    max-width:92%;
    animation: fadeIn .18s ease-out;
  }
  .dock.left  .dock-card{ margin-right:auto; }
  .dock.right .dock-card{ margin-left:auto; }

  @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

  .hotspot{
    position:absolute;width:24px;height:24px;border-radius:50%;
    background:#2b74ff;border:1px solid #fff;color:#fff;
    display:flex;align-items:center;justify-content:center;
    font:800 12px/1 system-ui;box-shadow:0 2px 6px rgba(0,0,0,.45);
    transform:translate(-50%,-50%);cursor:pointer;z-index:10
  }

  .panel{
    width:min(96vw,1200px);margin:0 auto;
    background:var(--card);border-radius:12px;
    padding:12px;display:grid;gap:12px;
    grid-template-columns:repeat(12,1fr)
  }

  .section{grid-column:1/-1;font:700 12px/1.2 system-ui;letter-spacing:.04em;text-transform:uppercase;opacity:.7;margin-top:4px}
  .group{background:rgba(255,255,255,.05);border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px}
  .group--2 {grid-column: span 6}
  .group--3 {grid-column: span 4}
  .group--4 {grid-column: span 3}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;opacity:.8}
  input[type=range]{width:100%}
  button{border:0;border-radius:10px;padding:9px 12px;background:#2a2a2a;color:#fff;font-weight:600;cursor:pointer}
  .btn-ghost{background:transparent;outline:1px solid rgba(255,255,255,.25)}
  .btn-ghost.on{box-shadow:0 0 0 2px rgba(74,222,128,.55) inset; background:#233a2d}

  .val-small{
    width:42px;
    text-align:right;
    font-size:12px;
    opacity:.85;
    font-variant-numeric:tabular-nums;
  }

  @media (max-width:1000px){
    .group--4{grid-column:span 4}
    .group--3{grid-column:span 6}
  }

  /* MOBILE: dock bottom-sheet */
  @media (max-width:700px){
    .group--4,.group--3,.group--2{grid-column:span 12}

    .dock{
      top:auto;bottom:0;left:0;right:0;width:100%;
      padding:10px;
      flex-direction:column-reverse;
      align-items:center;
      justify-content:flex-end;
      background:linear-gradient(0deg,rgba(0,0,0,.65),transparent);
    }
    .dock-card{
      max-width:calc(100% - 24px);
      width:calc(100% - 24px);
      margin:0 auto;
      max-height:40vh;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Epigrafe Claudia Nova</h1>

  <div id="stage">
    <div id="badge">HOTSPOT MODE</div>
    <div id="dockL" class="dock left"></div>
    <div id="dockR" class="dock right"></div>
  </div>

  <div class="panel">

    <div class="section">Visualizzazione</div>

    <div class="group group--4">
      <label>Orbit (auto-rotate)</label>
      <div class="row">
        <button id="orbitToggle" class="btn-ghost">OFF</button>
        <span style="font-size:12px;opacity:.8">Velocità</span>
        <input id="orbitSpeed" type="range" min="0" max="2" step="0.05" value="0.5" style="flex:1">
        <span id="orbitVal" style="font-size:12px;opacity:.8;width:42px;text-align:right">0.5°/s</span>
      </div>
    </div>

    <div class="group group--3">
      <label>Zoom (FOV)</label>
      <input id="fov" type="range" min="25" max="75" step="1" value="45">
    </div>

    <div class="group group--3">
      <label>Luminosità</label>
      <input id="exposure" type="range" min="1.0" max="3.2" step="0.05" value="2.6">
    </div>

    <div class="group group--4">
      <label>Camera</label>
      <div class="row">
        <button id="fit" class="btn-ghost">Inquadra</button>
        <button id="reset" class="btn-ghost">Reset</button>
      </div>
    </div>

    <div class="group group--4">
      <label>Ambiente</label>
      <div class="row">
        <button class="btn-ghost env on" data-hdr="on">HDR</button>
        <button class="btn-ghost env" data-hdr="off">None</button>
      </div>
    </div>

    <div class="group group--4">
      <label>Sfondo</label>
      <div class="row">
        <button class="btn-ghost bg on" data-bg="dark">Nero</button>
        <button class="btn-ghost bg" data-bg="light">Bianco</button>
        <button class="btn-ghost bg" data-bg="transparent">Trasparente</button>
        <button class="btn-ghost bg" data-bg="gradient">Gradiente</button>
      </div>
    </div>

    <!-- ORIENTAMENTO — MODIFICATO -->
    <div class="group group--4">
      <label>Orientamento</label>

      <div class="row">
        <button id="rzp" class="btn-ghost">Z +90°</button>
        <button id="ryp" class="btn-ghost">Y +180°</button>
        <button id="rotReset" class="btn-ghost">Reset rot.</button>
        <button id="rotDump" class="btn-ghost">Salva rot.</button>
      </div>

      <!-- DEBUG ROTAZIONE LIVE -->
      <div class="row" style="font-size:12px;opacity:.85;margin-top:4px">
        <span>Rotazione attuale</span>
        <code id="rotInfo"
              style="font-size:11px;background:rgba(0,0,0,.45);
                     padding:3px 6px;border-radius:6px">
          x:0.00000 y:0.00000 z:0.00000
        </code>
        <button id="rotCopy"
                class="btn-ghost"
                style="margin-left:auto;font-size:11px;padding:6px 8px">
          Copia
        </button>
      </div>
    </div>

    <div class="section">Annotazioni</div>

    <div class="group group--3">
      <label>Hotspot</label>
      <div class="row"><button id="toggleH" class="btn-ghost">Modalità H</button></div>
      <small>Premi anche la <b>H</b> da tastiera</small>
    </div>

    <div class="group group--3">
      <label>Misurazione</label>
      <div class="row"><button id="measure" class="btn-ghost">Misura A–B</button><button id="measureReset" class="btn-ghost">Reset</button></div>
      <small id="mhelp" style="opacity:.75">Clicca A poi B sulla mesh.</small>
    </div>

    <div class="section">Luci</div>

    <div class="group group--4">
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Key (destra)</span>
        <input id="keyIntensity" type="range" min="0" max="4" step="0.05" value="2.2" style="flex:1">
        <span id="valKey" class="val-small">2.2</span>
      </div>
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Direzionale</span>
        <input id="dirIntensity" type="range" min="0" max="4" step="0.05" value="3.0" style="flex:1">
        <span id="valDir" class="val-small">3.0</span>
      </div>
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Fill</span>
        <input id="fillIntensity" type="range" min="0" max="3" step="0.05" value="1.8" style="flex:1">
        <span id="valFill" class="val-small">1.8</span>
      </div>
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Hemi</span>
        <input id="hemiIntensity" type="range" min="0" max="3" step="0.05" value="1.6" style="flex:1">
        <span id="valHemi" class="val-small">1.6</span>
      </div>
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Ambiente</span>
        <input id="ambIntensity" type="range" min="0" max="1" step="0.01" value="0.25" style="flex:1">
        <span id="valAmb" class="val-small">0.25</span>
      </div>
      <div class="row" style="width:100%">
        <span style="flex:0 0 110px">Riflessi (envMap)</span>
        <input id="envIntensity" type="range" min="0" max="5" step="0.1" value="2.6" style="flex:1">
        <span id="valEnvI" class="val-small">2.6</span>
      </div>
    </div>
  </div>
</div>

<!-- ThreeJS -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/RGBELoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/renderers/CSS2DRenderer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

<script>
/* ===== Utilities ===== */
const fmt=v=>(Math.round(+v*100)/100).toString();
function setActive(btn,on){btn.classList.toggle('on',!!on)}

const stage=document.getElementById('stage');
const dockL=document.getElementById('dockL');
const dockR=document.getElementById('dockR');
const badge=document.getElementById('badge');

/* ===== Three.js base ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0e0e0e);

const camera=new THREE.PerspectiveCamera(45,stage.clientWidth/stage.clientHeight,0.01,100);
camera.position.set(0.9,0.9,1.8);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(stage.clientWidth,stage.clientHeight);
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=2.6;
renderer.physicallyCorrectLights=true;
stage.appendChild(renderer.domElement);

/* ===== Rotazione LIVE (nuovo) ===== */
const rotInfo=document.getElementById('rotInfo');
const rotCopy=document.getElementById('rotCopy');
function updateRotationUI(){
  if(!model) return;
  const r=model.rotation;
  rotInfo.textContent=`x:${r.x.toFixed(5)} y:${r.y.toFixed(5)} z:${r.z.toFixed(5)}`;
}
rotCopy.onclick=()=>{
  if(!model) return;
  const r=model.rotation;
  const txt=`ORIENT: { x:${r.x.toFixed(5)}, y:${r.y.toFixed(5)}, z:${r.z.toFixed(5)} }`;
  navigator.clipboard?.writeText(txt);
  console.log(txt);
};

const labelRenderer=new THREE.CSS2DRenderer();
labelRenderer.setSize(stage.clientWidth,stage.clientHeight);
labelRenderer.domElement.style.position='absolute';
labelRenderer.domElement.style.top='0';
labelRenderer.domElement.style.left='0';
labelRenderer.domElement.style.pointerEvents='none';
stage.appendChild(labelRenderer.domElement);

const controls=new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;

/* ===== Lights ===== */
const hemi=new THREE.HemisphereLight(0xffffff,0x222233,1.6);
const dir=new THREE.DirectionalLight(0xffffff,3.0); dir.position.set(2,2,2);
const fill=new THREE.DirectionalLight(0xffffff,1.8); fill.position.set(-2,1.2,-1.5);
const amb=new THREE.AmbientLight(0xffffff,0.25);
const rightKey=new THREE.SpotLight(0xffffff,2.2,5,Math.PI/8,0.2,1.0);
rightKey.position.set(1.2,0.6,0.6);
rightKey.target.position.set(0.0,0.3,-0.1);
scene.add(hemi,dir,fill,amb,rightKey,rightKey.target);

/* ===== Env HDR ===== */
let envTexture=null;
new THREE.RGBELoader()
.setPath('https://cdn.jsdelivr.net/npm/three@0.146.0/examples/textures/equirectangular/')
.load('venice_sunset_1k.hdr',tex=>{
  tex.mapping=THREE.EquirectangularReflectionMapping;
  envTexture=tex; scene.environment=envTexture;
});

/* ===== Model ===== */
const ORIENT={x:1.57080,y:0.0,z:4.71239};
let model=null;
const defaultRotation=new THREE.Euler(ORIENT.x,ORIENT.y,ORIENT.z,'XYZ');

new THREE.GLTFLoader().load(
  'https://edoarch94.github.io/DOTTORATO_UMAP2/modelli/Monumento.glb',
  g=>{
    model=g.scene;
    model.rotation.copy(defaultRotation);
    scene.add(model);

    const box=new THREE.Box3().setFromObject(model);
    const ctr=box.getCenter(new THREE.Vector3());
    model.position.sub(ctr);

    fitToObject(model,1.25);
    updateRotationUI();
  }
);

/* ===== Fit ===== */
function fitToObject(object,margin=1.25){
  const box=new THREE.Box3().setFromObject(object);
  const size=box.getSize(new THREE.Vector3());
  const radius=size.length()*0.5;
  const fov=camera.fov*Math.PI/180;
  const dist=(radius/Math.sin(fov/2))*margin;
  const dirv=new THREE.Vector3(0,0.35,1).normalize();
  const newPos=dirv.multiplyScalar(dist);
  controls.target.set(0,0,0);
  camera.position.copy(newPos);
  camera.lookAt(controls.target);
  camera.updateProjectionMatrix();
}

/* ===== Orientamento (modificato) ===== */
document.getElementById('rzp').onclick=()=>{
  if(!model) return;
  model.rotation.z+=Math.PI/2;
  updateRotationUI();
};
document.getElementById('ryp').onclick=()=>{
  if(!model) return;
  model.rotation.y+=Math.PI;
  updateRotationUI();
};
document.getElementById('rotReset').onclick=()=>{
  if(!model) return;
  model.rotation.copy(defaultRotation);
  updateRotationUI();
};
document.getElementById('rotDump').onclick=()=>{
  if(!model) return;
  const r=model.rotation;
  console.log(`ORIENT: { x:${r.x.toFixed(5)}, y:${r.y.toFixed(5)}, z:${r.z.toFixed(5)} }`);
};

/* ===== Orbit ===== */
const orbitBtn=document.getElementById('orbitToggle');
const orbitSpeed=document.getElementById('orbitSpeed');
const orbitVal=document.getElementById('orbitVal');
let autoOrbit={active:false,degPerSec:+orbitSpeed.value};

orbitBtn.onclick=()=>{
  autoOrbit.active=!autoOrbit.active;
  orbitBtn.textContent=autoOrbit.active?'ON':'OFF';
  setActive(orbitBtn,autoOrbit.active);
};
orbitSpeed.oninput=e=>{
  autoOrbit.degPerSec=+e.target.value;
  orbitVal.textContent=`${fmt(autoOrbit.degPerSec)}°/s`;
};

/* ===== Resize & Render ===== */
function onResize(){
  const w=stage.clientWidth, h=stage.clientHeight;
  camera.aspect=w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h);
  labelRenderer.setSize(w,h);
}
addEventListener('resize',onResize);

let lastT=performance.now();
(function animate(now){
  requestAnimationFrame(animate);
  const dt=(now-lastT)/1000; lastT=now;

  if(autoOrbit.active){
    const deltaRad=THREE.MathUtils.degToRad(autoOrbit.degPerSec)*dt;
    const v=camera.position.clone().sub(controls.target);
    v.applyAxisAngle(new THREE.Vector3(0,1,0),deltaRad);
    camera.position.copy(controls.target.clone().add(v));
  }

  controls.update();
  TWEEN.update();
  renderer.render(scene,camera);
  labelRenderer.render(scene,camera);

  updateRotationUI(); /* NUOVO */
})();
</script>
</body>
</html>
